<!DOCTYPE html>
<html>
<head>
  <title>Inference in the balanced one-way random effect ANOVA</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="" />
  <meta name="author" content="">
  <link rel="shortcut icon" href="assets/img/07-10-06_2241.jpg">
  <link rel="alternate" type="application/rss+xml" href="">
  <link href="../libraries/frameworks/purus/css/bootstrap.min.css" rel="stylesheet" />
  <link href="../libraries/frameworks/purus/css/bootstrap-responsive.min.css" rel="stylesheet" />
  <link href="../libraries/frameworks/purus/css/main.css" rel="stylesheet" />
  <link href="../libraries/highlighters/prettify/css/twitter-bootstrap.css" rel="stylesheet">
  <!-- IE6-8 support of HTML5 elements -->
  <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <link href='http://fonts.googleapis.com/css?family=Raleway:400,600,200,800' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=Droid+Sans' rel='stylesheet' type='text/css'>
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
    <style>
    #disqus_thread {
		margin-top: 140px;
	}
	  #sidebar .sidebar-nav .info h3 a:hover, a:hover { color: #01A9DB; }
	  #sidebar .sidebar-nav #avatar img, #sidebar .sidebar-nav ul#links li.active a { border-color: #01A9DB; }
	  #sidebar .sidebar-nav ul#links li a:hover { background: #01A9DB; }
    p {text-align: justify;}
  </style>
  <link rel="stylesheet" href = "../assets/css/box_with_title.css">
<link rel="stylesheet" href = "../assets/css/custom.css">
<link rel="stylesheet" href = "../assets/css/ribbons.css">

</head>
<body>
	<div class="container-fluid">
		<div class="row-fluid">
			<div id="sidebar" class="span2">
			  <div class="sidebar-nav sidebar-nav-fixed">
				  <div class="info">
				    <p id="avatar"><a href="#"><img alt="Title" src="http://stla.github.com/stlapblog/assets/img/07-10-06_2241.jpg " style="width:250px" /></a></p>
				    <h3><a href="/">stlaPblog </a></h3>
					  <p class="description">a blog about Mathematics, R, Statistics, ...</p>
					</div>
					<ul id="links">
			        <li><a href="http://stla.github.com/stlapblog/index.html">Home</a></li>
        <li><a href="http://stla.github.com/stlapblog/about.html">About</a></li>
      
				  <br/>
				  <div style="padding-left: 5px;">
					<h3>Some links</h3>
					<h4>&#9654 R links</h4>
						<div style="padding-left: 5px;">
					    <ul>
					      <li><a href="http://github.com/ramnathv/poirot/"><u>Poirot</u></a>Reproducible Blogging with R Markdown</li>
			          <li><a href="http://slidify.org/"><u>Slidify</u></a>Reproducible html5 slides from R markdown</li>
			          <li><a href="http://www.r-bloggers.com/"><u>R-bloggers</u></a>Blog posts about R, contributed by R bloggers worldwide.</li>
					    </ul>
				    </div>
			    <br/>
			  	<h4>&#9654 Blogs</h4>
						<div style="padding-left: 5px;">
					    <ul>
					      <li><a href="http://stla.overblog.com/"><u>stla.overblog</u></a>My previous blog</li>
			          <li><a href="http://timelyportfolio.blogspot.be/"><u>Timely Portfolio</u>
			</a>A great blog about R, Javascript, and more</li>
					    </ul>
				    </div>
					</div>
			    </ul>
				</div>
			</div>
						<div id="content" class='span10'>
				<div id="post-wrapper">
          <ol id="posts">
            <li class="post">
              <h3>
                <a href="#">Inference in the balanced one-way random effect ANOVA</a>
              </h3>
              <span>2015-03-12</span><br/>
               <a class='label label-success' href='https://raw.github.com/stla/stlapblog/gh-pages/posts/Anova1random_inference.Rmd'>Source</a>
              <div class='lead'>



<p>The one-way random effect ANOVA model is the simplest linear Gaussian model with random effects: one random factor, and no other factor or covariate. However, methods of inference to get estimates, confidence intervals for various parameters (variance components, coefficient of variation), prediction intervals and tolerance intervals, are not so well-known. This is what we provide in this article, in the simplest situation : the case of <em>balanced data</em> (at the end we give a possible way to handle the unbalanced situation).</p>
<p>Recall that, denoting by <span class="math">\(y_{ij}\)</span> the <span class="math">\(j\)</span>-th response in group <span class="math">\(i\)</span>. this model assumes that the responses <span class="math">\(y_{ij}\)</span> are generated in two steps. First, the group means <span class="math">\(\mu_i\)</span> are independently generated according to a Gaussian distribution <span class="math">\({\cal N}(\mu, \sigma^2_b)\)</span> where <span class="math">\(\mu\)</span> is the overall mean and <span class="math">\(\sigma^2_b\)</span> is the so-called <em>between variance</em>. Second, the responses <span class="math">\(y_{ij}\)</span>, <span class="math">\(j =1,\ldots,J\)</span>, for each group <span class="math">\(i\)</span>, are independently distributed according to a Gaussian distribution <span class="math">\({\cal N}(\mu_i, \sigma^2_w)\)</span> with <em>within variance</em> <span class="math">\(\sigma^2_w\)</span> and mean <span class="math">\(\mu_i\)</span>. Shortly, the model can be written: <span class="math">\[\begin{cases}
\mu_i \sim_{\text{iid}} {\cal N}(\mu, \sigma^2_b) &amp; i=1,\ldots,I 
\\
 (y_{ij} \mid \mu_i) \sim_{\text{iid}} {\cal N}(\mu_i, \sigma^2_w) &amp; j=1,\ldots,J 
\end{cases}.\]</span></p>
<p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAogAAAGwCAMAAAAdVmTVAAABRFBMVEX9/v0AAAAAADkAAGUAAIAAAMAAAP4AAP8AOY8AZrUAZv4AgAAAwAAA/wAA/zkA/2UA/48A/7U5AAA5ADk5AGU5AP85OQA5OWU5OY85Of85j9o5j/05/wA5/2U5/9o/P/8//z9lAABlADllAGVlAP9lOQBlOY9lZgBltf1l/v1l/wBl/zlm/wB+f/5+/36AAACPOQCPOTmPOf+PZgCPtY+P29qP2/2P/v2Q2wC1ZgC1Zjm1ZmW1Zv61Zv+1/rW1/v21/wC1/zm1/2W2tgDAAADajznaj4/aj/7aj//a24/a/v3a/zna/4/wAAD9j4/9tWX9tf7924/92/79/mX9/o/9/rX9/tr9/v39/v7+AAD+ADn+OTn+ZgD+Zjn+ZmX+f37+tY/+tf3+2/3+/v3/AAD/ADn/AGX/Dw//OQD/Pz//ZrX/j9r8/FvKAAAAbHRSTlP///////////////////////////////////////////////////////////////////////////////////////////////////////////////////8A///////////////////////////tOt6RAAAACXBIWXMAAAsSAAALEgHS3X78AAATpUlEQVR4nO3d64Pb2FmA8TrJ4k2zBhpogbSQzFLoLJBkWugsBsJsaYaWlDJNW4/aEghLDcvA//8dy/JFsnR0bu+RXknP82HHGUvH8vi3OvL9SxmRgr7U9wYQ5QGRVAREUhEQSUVAJBUBkVQERFIREElFQCQVAZFUBERSERBJRUAkFQGRVAREUhEQSUVAJBUBkVQERFIREElFQCQVAZFUBERSERBJRUAkFQGRVAREUhEQSUVAJBUBkVQERFIREElFQCQVAZFUBERSERBJRUAkFQGRVAREUhEQSUVAJBUBkVQERFIREElFQCQVAZFUBERSERBJRUAkFQGRVAREUhEQSUVAJBUBkVQERFIREFM1a6jvbVIcEBPUZBCN7QFRuhZwaDQHRNnszKDYGBDl8hCGxdOAKJTvjo4dYzUgihSECoqlgBhfjCcs7gJibLGUoLgNiFHJKMIiEKOSAwRFIAYnbGfiEoEYmjycSVMEYlhJ0Ex5fgZiSMnETPdYEYj+JcUyVYpA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" /></p>
<p>If you like the moment of inertia representation of the variance on this picture (I do), see <a href="http://stla.github.io/stlapblog/posts/Variance_inertia.html">my article about it</a>.</p>
<p>Throughout the article, we will use the following function to get the within sum-of-squares <span class="math">\(SS_w\)</span> and the between sum-of-squares <span class="math">\(SS_b\)</span>:</p>
<pre class="r"><code>SOS &lt;- function(y, group){
  require(dplyr)
  return(data.frame(y=y,group=group) %&gt;% mutate(mean=mean(y)) %&gt;% group_by(group) %&gt;% mutate(groupmean=mean(y)) %&gt;% ungroup %&gt;% do(summarise(., SSw=crossprod(y-groupmean), SSb=crossprod(groupmean-mean))) %&gt;% as.list)
  }</code></pre>
<div id="bayesian-posterior-distributions" class="section level2">
<h2>Bayesian posterior distributions</h2>
<p>All Bayesian methods we provide are based on the posterior distributions generated by this code. I’m using a <code>data.table</code> for storing the stimulations.</p>
<pre class="r"><code>ranova &lt;- function(y, group, nsims=50000){
  require(data.table)
  group &lt;- factor(group)
  I &lt;- length(levels(group))
  if(!all(I*as.numeric(table(group))==length(y))){ stop(&quot;balanced only!&quot;) }
  J &lt;- length(y)/I
  SS &lt;- SOS(y, group) #  sum of squares SSb SSw
  SSb &lt;- SS$SSb; SSw &lt;- SS$SSw
  omean &lt;- mean(y)
  k &lt;- tot &lt;- 0
  z &lt;- rnorm(nsims)
  ETAb &lt;- ETAw &lt;- rep(NA,nsims)
  while(k &lt; nsims){
    tot &lt;- tot +1
    etab &lt;- SSb/rchisq(1, I-1)  
    etaw &lt;- SSw/rchisq(1, I*(J-1))
    if(etab&gt;etaw){
      k &lt;- k+1
      ETAb[k] &lt;- etab
      ETAw[k] &lt;- etaw
      }
    }
  out &lt;- data.table(mu=omean + sqrt(ETAb/I/J)*z, sigma2w=ETAw, sigma2b=(ETAb-ETAw)/J)
  reject &lt;- 100*(tot-nsims)/tot
  cat(&quot;Rejection percentage: &quot;, round(reject,1), &quot;%&quot;)
  setattr(out, &quot;reject&quot;, reject)
  return(out)
  }</code></pre>
<p>These posterior distributions can be found in <a href="/" title="Kalimuthu Krishnamoorthy, Thomas Mathew. *Statistical Tolerance Regions: Theory, Applications, and Computation*. Wiley 2009.">Krishnamoorthy &amp; Mathew</a>’s book. I believe they are derived in <a href="/" title="George E.P. Box, George C. Tiao. *Bayesian Inference in Statistical Analysis*. Wiley 1992.">Box &amp; Tiao</a>’s book.</p>
<p>As we can see in the body of the function, the algorithm firstly generates simulations of a couple <span class="math">\((\eta_w, \eta_b)\)</span> whose joint distribution is given two inverse-Gamma distributions <span class="math">\({\cal IG}\left(\frac{I(J-1)}{2},\frac{SS_w}{2}\right)\)</span> and <span class="math">\({\cal IG}\left(\frac{I-1}{2},\frac{SS_b}{2}\right)\)</span> conditionned to <span class="math">\(\eta_b &gt; \eta_w\)</span>, and then <span class="math">\(\sigma^2_w=\eta_w\)</span> <span class="math">\(\sigma^2_b=\frac{\eta_b-\eta_w}{J}\)</span>. The <code>ranova</code> function also prints the percentage of rejected simulations (those for which <code>etab&lt;etaw</code>) and also returns it as an attribute of the <code>data.table</code> containing the simulations.</p>
<p>Note that <span class="math">\(\eta_b = J\tau^2\)</span> where <span class="math">\(\tau^2=\sigma_b^2+\frac{\sigma_w^2}{J}\)</span> is the variance of a group mean <span class="math">\(\bar y_{i\bullet}\)</span>. Given the sum of squares <span class="math">\(SS_w\)</span> and <span class="math">\(SS_b\)</span>, the probability of rejection is, using abusive notation, <span class="math">\[\begin{align}
R(SS_w,SS_b) &amp; = \Pr\left(\frac{\chi^2_{I(J-1)}}{\chi^2_{I-1}} &lt; \frac{SS_w}{SS_b}\right) \\
  &amp; = \Pr\left({\cal Beta}'\left(\frac{I(J-1)}{2}, \frac{I-1}{2}\right) &lt; \frac{SS_w}{ SS_b} \right) \\
  &amp; = \Pr\left({\cal Beta}\left(\frac{I(J-1)}{2}, \frac{I-1}{2}\right) &lt; \frac{SS_w}{SS_w + SS_b} \right).
\end{align}\]</span></p>
<p>Moreover, as is well known or <a href="http://stla.github.io/stlapblog/posts/Anova1random.html">as shown here</a>, the sum of squares <span class="math">\(SS_w\)</span> and <span class="math">\(SS_b\)</span> are independent and <span class="math">\(SS_w \sim \sigma^2_w\chi^2_{I(J-1)}\)</span> and <span class="math">\(SS_b \sim J\tau^2\chi^2_{I-1}\)</span>.</p>
<p>Therefore the rejection probability over repeated sampling is <span class="math">\[
R = \Pr\left(\frac{{\cal Beta}'\left(\frac{I(J-1)}{2}, \frac{I-1}{2}\right)}{{\cal Beta}'\left(\frac{I(J-1)}{2}, \frac{I-1}{2}\right)} &lt; \frac{\sigma^2_w}{J\tau^2}  \right).
\]</span> Let <span class="math">\(\rho:=\dfrac{\sigma^2_w}{\sigma^2_w+\sigma^2_b}\)</span> be the ratio of the within-variance over the total variance, and note that <span class="math">\(\dfrac{\sigma^2_w}{J\tau^2} = \dfrac{\rho}{\rho+J(1-\rho)}\)</span> (an increasing function of <span class="math">\(\rho\)</span>). There is no elementary cumulative distribution fonction for the ratio of the two independent Beta prime distributions, but we can easily plot <span class="math">\(R\)</span> in function of <span class="math">\(\rho\)</span> with the help of simulations. We use Javascript in order to include interactivity for the choice of <span class="math">\(I\)</span> and <span class="math">\(J\)</span>, and the <a href="https://github.com/flot/flot">Javascript flot library</a> to render the plot:</p>
<iframe width="100%" height="440px" src="http://stla.github.io/stlapblog/posts/assets/htmlframes/AV1R_Rprob.html"></iframe> 

<p>As an exercise, you can check why the probability of rejection always is <span class="math">\(50\%\)</span> for <span class="math">\(\rho=1\)</span>.</p>
</div>
<div id="simulated-data" class="section level2">
<h2>Simulated data</h2>
<p>Throughout the article, we will illustrate the methods on two datasets, <code>dat1</code> and <code>dat2</code>. I load the <code>magrittr</code> package to use the pipe operator <code>%&gt;%</code>.</p>
<pre class="r"><code>library(magrittr)
set.seed(314)
I &lt;- 3
J &lt;- 6
mu &lt;- 10
sigmab &lt;- 2
sigmaw &lt;- 1
dat1 &lt;- data.frame(sapply(rnorm(I,mu,sigmab), function(mu) rnorm(J,mu,sigmaw))) %&gt;%
  setNames(LETTERS[1:I]) %&gt;% stack %&gt;% setNames(c(&quot;y&quot;, &quot;group&quot;))
sigmab &lt;- 1
dat2 &lt;- data.frame(sapply(rnorm(I,mu,sigmab), function(mu) rnorm(J,mu,sigmaw))) %&gt;%
  setNames(LETTERS[1:I]) %&gt;% stack %&gt;% setNames(c(&quot;y&quot;, &quot;group&quot;))
# stacked datasets
dat &lt;- rbind(cbind(data=&quot;dat1&quot;, dat1), cbind(data=&quot;dat2&quot;, dat2))</code></pre>
<p>The between-variance <span class="math">\(\sigma_b^2\)</span> is the only difference between the parameters used to generate our two datasets (<span class="math">\(4\)</span> vs <span class="math">\(1\)</span>). We can already store the posterior simulations of the Bayesian method:</p>
<pre class="r"><code>sims1 &lt;- with(dat1, ranova(y, group, nsims=1e6))
## Rejection percentage:  0 %
sims2 &lt;- with(dat2, ranova(y, group, nsims=1e6))
## Rejection percentage:  19.2 %
# stacked simulations in a data.table
sims &lt;- rbind(sims1[, &quot;data&quot;:=&quot;data1&quot;], sims2[,&quot;data&quot;:=&quot;data2&quot;])
setkey(sims, data)</code></pre>
<p>Note that the theoretical rejection percentages could be calculated with our above formula of <span class="math">\(R(SS_w,SS_b)\)</span>:</p>
<pre class="r"><code>by(dat, dat$data, FUN=function(data){
  with(data, 
       with(SOS(y,group), 
            round(100*pbeta(SSw/(SSw+SSb), I*(J-1)/2, (I-1)/2), 1)
            )
       )
  })
## dat$data: dat1
## [1] 0
## -------------------------------------------------------- 
## dat$data: dat2
## [1] 19.1</code></pre>
<p>Because there is no rejection for the first dataset, the posterior distribution of <span class="math">\(\eta_b\)</span> is <span class="math">\({\cal IG}\left(\frac{I-1}{2},\frac{SS_b}{2}\right)\)</span>, as confirmed by the density plot below (see this <a href="http://stats.stackexchange.com/questions/65866/good-methods-for-density-plots-of-non-negative-variables-in-r/">stats.stackexchange discussion</a> if you wonder why I use the <code>logspline</code> package):</p>
<pre class="r"><code>with(dat1, 
     {
       ssb &lt;- J*crossprod(aggregate(y~group, FUN=mean)$y-mean(y))
       curve(dgamma(x,(I-1)/2, ssb/2), to=0.4, lwd=2, xlab=NA, ylab=NA, axes=FALSE)
      })
axis(1)
library(logspline)
x &lt;- 1/with(sims1[sample(nrow(sims1),1e4)], J*sigma2b+sigma2w)
plot(logspline(x), add = TRUE, col = &quot;red&quot;, lwd = 2)</code></pre>
<p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAbAAAAEgCAIAAABaSrE+AAAACXBIWXMAAAsSAAALEgHS3X78AAAZ6klEQVR4nO3deXyU9Z3A8e88c2UyuUmAJByJCoQIC1U5BRTqUVGhUCAU8AAFVvHVri6lLNtF3a6yLZ64dFsBEbYcAiqXaGtErcotSDlFCXc4QiAkk0zmfPaPeaSIMAkwmWfmyef9V2TizPcHySe/eebJMyZVVQUAIKLoPQAAxAqCCAAagggAGoIIABqCCAAagggAGoIIABqCCAAagggAGoIIABqCCAAagggAGoIIABqCCAAagggAGoIIABqCCAAagggAGoIIABqCCAAagggAGoIIABqCCAAagggAGoIIABqCCAAagggAGoIIABqCCAAagggAGoIIABqCCAAagggAGoIIABqCCAAagggAGoIIABqCCAAagggAGoIIABqCCAAagggAGoIIABqCCAAagggAGoIIABqCCAAagggAGoIIABqCCAAagggAGoIIABqCCAAagggAGoIIABqCCAAagggAGoIIABqCCAAagggAGoIIABqCCAAagggAGmMG8ZZbbinp109mzNB7EADxxJhBdLvdSevXE0QAV8SYQRw0aFCwtlb275cdO/SeBUDcMGYQBw4caAt9tGqVvpMAiCMmVVX1niHyVFWtMZudqirdu8v69XqPAyA+GDOIIuI3mwPBoN1sluPHJStL73EAxAFjPmUWVbWo6l9EJBDgWTOAejJoEL1eUdWv7PazTidBBFBPxg2iSH5BwcpgUD78UGpr9R4IQBwwchDbd+q0xO2W6mpZu1bvgQDEAYMH8VOLxWOz8awZQH0YOYjO9PRuffp8brfLypVi0BfTAUSQkYMoNltRUdGiqiopLZXt2/WeCUCsM2gQPR4REZtt8ODBKyyWgNksS5boPROAWGfQIH63Q8zMzOx0223rEhLkrbf0nglArDN0EO12ERkyZMj86mopKZGvvtJ5KgCxzdBBtNlEZNCgQSvN5qCiyNtv6zwVgNhm/CA2a9assHfv9QkJHEYEEJ7xgygiQ4cO/b+aGtm3T3bu1HMqALGtUQTxZz/72fLQs+Zly/ScCkBsM2gQvzvtJvRfzZo1a9OjxxaHgyACCMOgQbzgVeaQUaNGzauull27ZM8e3aYCENsMGkSfT+QfO0QRGTZs2Ps2m2oyybvv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jBo1asqUKTrOYMwgOp3OVatWtWjRQu9BomHFihUlJSVPPvmk3oNESd++fT/++GO9p4iSBx54YNq0aY3qK1nfGXjKDAAagggAGoIIABqCCAAagggAGmMGUVGU0OVDGgOz2dxITssIsVqteo8QPXwlR5kxf5fZ4/HY67q0kWEEg8FAINB4MtGo/nEb1WJj4SvZmEEEgKvQWHbjAFAngggAGoIIABqCCAAagggAGoIIABqCCACauA/ili1bbrrppvT09NGjR7t/8Pak4W+NR/VZUf/+/ffu3RvlwRpC+MUWFxd37tzZ6XT26tVr165dukwYQWEWq6rq008/nZOTk5iY2Lt37927d+s1ZATV5yt57969SUlJUR1LjWc+n69169azZs06evToj3/84+eee67+t8ajOldUXFz86KOPisiePXt0mTCCwi+2tLQ0KSlpyZIlFRUVv/nNbwoLC/WaMyLCL7a4uLhVq1a7d+8+derUmDFj7rnnHr3mjJT6fG/6/f4ePXqYzeZoDhbfQSwuLi4oKAh9/PHHH7dp06b+t8ajOlc0ffr0CRMmJCYmGiCI4Re7ePHi7t27hz72eDwmk+nMmTPRHjFywi+2pKRk06ZNwWCwoqJiypQpDz30kA4jRlR9vjdffvnloUOHRjmI8f0WAgcPHuzYsWPo444dOx46dEhVVZPJVJ9b41GdK5o4caKILF++XJ/5Iir8Yvv379+3b9/Qxxs2bMjLy4vrd5UJv9j8/Pz8/Py33npr+PDhmZmZmzdv1m/SyKjzK3n//v1//OMf16xZ884770RzsPg+hnj69Onk5OTQxykpKV6vt6qqqp63xiPjrSiM8ItNTk5u2rSpqqorVqwYMWLEq6++Gtc/6urzL1tUVFRdXf3www+PHj066gNGWPj1BoPBsWPHvvjiiykpKVEeLL53iOnp6S6XK/RxZWWlxWK58BBs+FvjkfFWFEadiy0vLx87duzhw4eXL19+yy236DFjxIRf7L59+xISElq1apWYmDh58uScnJx4vwpO+PXOnj07Jyfn3nvvPX36dJQHi+8d4nXXXXf+5cU9e/bk5eVdePG48LfGI+OtKIzwi/V4PHfddVf79u03btwY7zWUuha7fPnyl156KfRxTU2NoigWS3xvZcKvd+3atStXrszMzGzbtm0gEMjMzNywYUOUJovmAcuI8/l8OTk5S5curaqqGjBgwDPPPBP686VLlx49evRyt8av8Os9/2m5ubkGeFEl/GIXL17cqVOnAxfw+/36Dnwtwi928+bNTZs23bhxY1lZ2YMPPjhs2DB9p7124dd7+vTpI0eOHDlyZPv27YqiHDlypLa2NjqDxXcQVVXdvHlzp06dMjIyHn744fN/a6H3Zb7crXEt/HpDjBFENexiJ02adNGP9rKyMn2nvUbh/2XfeOONwsLC1NTUYcOGxftKQ+rzlVxWVhblV5m5QCwAaAx7BAoArhRBBAANQQQADUEEAA1BBAANQQQADUEEAA1BBAANQQQADUEEAA1BBAANQQQADUEEAA1BBAANQQQADUEEAA1BBAANQQQADUEEAA1BBAANQQQADUEEAA1BBAANQQQADUEEAA1BBAANQQQADUEEAA1BBAANQQQADUEEAA1BBAANQQQADUEEAA1BBAANQQQADUEEAA1BBAANQQQADUEEAA1BBAANQQQADUEEAA1BBAANQQQADUEEAA1BBADN/wP9GGfrWbZCowAAAABJRU5ErkJggg==" alt="plot of chunk unnamed-chunk-6" /></p>
<p>But not for the second dataset:</p>
<pre class="r"><code>with(dat2, 
     {
       ssb &lt;- J*crossprod(aggregate(y~group, FUN=mean)$y-mean(y))
       curve(dgamma(x,(I-1)/2, ssb/2), to=1, ylim=c(0,2.6), lwd=2, xlab=NA, ylab=NA, axes=FALSE)
      })
axis(1)
lines(density(1/with(sims2, J*sigma2b+sigma2w)), col=&quot;red&quot;, lwd=2)</code></pre>
<p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAbAAAAEgCAIAAABaSrE+AAAACXBIWXMAAAsSAAALEgHS3X78AAAgAElEQVR4nO3deVxU5eIG8GcGRQQFVBAYFBQFAUFZXFhccE1RATPMsquZS67dTG9l10yz1a0oy/X+XMtdUdFccMEFEVEQULZAZVdQckFAtt8fcy55zVDxwJk5PN+PHz+TM/OeR2qe3nPmnPcoKisrQUREgFLqAEREmoKFSEQkYCESEQlYiEREAhYiEZGAhUhEJGAhEhEJWIhERAIWIhGRgIVIRCRgIRIRCViIREQCFiIRkYCFSEQkYCESEQlYiEREAhYiEZGAhUhEJGAhEhEJWIhERAIWIhGRgIVIRCRgIRIRCViIREQCFiIRkYCFSEQkYCESEQlYiEREAhYiEZGAhUhEJGAhEhEJWIhERAIWIhGRgIVIRCRgIRIRCViIREQCFiIRkYCFSEQkYCESEQlYiEREAhYiEZGAhUhEJGAhEhEJWIhERAIWIhGRgIVIRCRgIRIRCViIREQCFiIRkYCFSEQkYCESEQlYiEREAhYiEZGAhUhEJGAhEhEJWIhERAIWIhGRgIVIRCRgIRIRCViIREQCFiIRkYCFSEQkYCESEQlYiEREAhYiEZGAhUhEJGAhEhEJWIhERAIWIhGRgIVIRCRgIRIRCViIREQCFiIRkaD+FeLdu5g6FQMGYOxYnDkjdRoi0iCKyspKqTPUocxMeHsjOxvu7khORkEBRo7EihVo3lzqZEQkvXo2Q/zsM9y8idOnERGBzEx89RX27UOnTggLkzoZEUmvPhViQgI2bMCUKfDwAAB9fcyZg8hING6MAQPw449S5yMiidWnXea33sK+fUhNhanp//x5QQHGjsX+/Rg7FitXQk9PonxEJLF6M0MsL8fBgxg58sk2BNCsGfbuxaefYuNG9OuHW7ekyEdE0qs3hRgVhYICDBz49GcVCnz+ObZsweXL8PDAlSt1G46INEK9KcSjR6FUom/f6l7z+us4cwalpfD2xoEDdZWMiDRFfSpEV1eYmDzjZS4uOH8etrbw88OXX6L+HGAlovpSiA8eICICAwY814tVKoSFYfhwzJ2LMWNQUlLL4YhIU9SPQoyKwqNH8PF53tfr62P7dnz0ETZvRr9+yMurxWxEpDHqRyFevQoATk4v8BalEt98g82bcekSPDyEEYhI1upNIRoZwdLyhd84ejROn0ZxMby9ERpaC8mISIPUj0JMSICjYw3f6+6OyEjY2GDwYKxaJWosItIs9aMQr16Fg0PN325piVOnMGwYJk/G5Ml49Ei8ZESkQepBId65g9zcms8Q1QwMsGsXFizAmjXo2xe5uSKFIyINIs9CnDRp0q5du4R/UH8f8pKFCEChwLx5CA5GfDy6dEF4+MsOSEQaRp6FmJGRERgYOGvWrLKyMiQkAGIUotqwYTh/HoaG8PHhAjlEMiPP1W7Kyso+/vjjpUuX9urV62CHDgZbtuDePSgUom3g3j2MGYO9ezF6NFavhr6+aCMTkXTkWYhqW7ZsmTBhQkh5eRdr66ZJSSKPXlmJBQvw+edwccGePbC2Fnl8Iqpzci5EAHFxcY27dIkrLb26cOGcOXOUSrEPEezdizFjoKuLbduesXIEEWk8eR5DrOLs7NyuYUM9O7u5c+cOHTo0Pz9f5A34+yMiAs2b45VX8P33Ig9ORHVL5oWIO3cUhYWDJ01asWLFiRMn3NzcwkX/dtjBAZGReOUVzJyJsWNRXCzy+ERUV+ReiBkZAGBlNXny5PDw8EaNGvn4+CxdulTkAwVGRti3D59/jl9+QY8eSEsTc3AiqityL8T0dABo3RqAq6vrxYsX/f39Z8+e7efnJ/Lus1KJTz/FkSO4cQPu7ti5U8zBiahO1I9CtLJS/5OhoeGOHTs2bNhw8uRJR0fHgwcPiry5vn0RFQUHBwQGYvx4PHgg8vhEVJvkXogZGWjUCGZmj//ZmDFjwsPDTU1N/fz85s2bV1ZWJuYWra1x6hTmzcOGDXBzQ1SUmIMTUW2SeyGmp6NVK/zlbBtnZ+cLFy6MHz9+4cKFPXv2TBP3qF+DBliwAIcOobAQXl74+muI27lEVDvkXogZGeoDiH+lr6+/atWqPXv2pKSkuLi4rF+/XuRN9++P+HiMGoVPPoG3t3AFIRFpMLkXYnp61QHEpwoICIiNjfX09Bw3btyIESNE/qalWTNs3IitW5GSAjc3LF6M8nIxxyciUcm6EMvKkJ1dfSECUKlUhw4d+vHHHw8dOuTs7HxA9BuQvv46rlzBgAH48EP07AnRLyIkIpHIuhCzs1FW9ne7zI9TKBTTp0+/dOmSmZnZsGHDJk+eXFhYKGYSCwvs24cNG5CYCFdXLF2KigoxxyciMci6ELOyADxzhlilQ4cOERERs2fPXrt2rYuLy7lz50TOM2YM4uPRvz9mz0avXrxxFZGmkXUhqte1Njd//nfo6ektWrTo1KlTSqWyZ8+eH3/8cbG4l+KpVMJUMSEBrq6YN483JCDSHCzEp/Dy8oqJifnnP/+5ePFid3f3CxcuiBxszBgkJCAwEAsXomtXxMaKPD4R1YisC/HmTejowNS0Bm9t3Ljx0qVLw8LCHj165OXl9dFHHxUVFYmZrWVLbN6M4GDcuoXu3XlUkUgTyLoQc3NhagodnRoP0KNHj8uXL0+dOnXJkiUuLi6nT58WMR0A+PsjPh7+/pg9Gz17clUIImnJvRD/96K9GtDX1w8KCjp+/HhZWZmPj8+MGTMeiHuFcosW2LoV69cjLg4uLti4UczBiehFyL0QX/wA4lP17t07NjZ2+vTpP//8s5OT05EjR0QZ9k9jxyI6Gh07YuxYvPEGCgpEHp+IngML8XkZGBgEBQWdPn1aX19/0KBBY8eOFfmylnbtcOYMvv0We/agY0fs3y/m4ET0HGRdiDdviliIal5eXpcuXfr000+3bt3q4OCwYcMGMdea1dHBhx8iMhImJvDzQ2AgMjNFG5yInkW+hfjHHyguFr0QAejp6S1YsCAmJsbBweHtt9/u27dvgrgLN3TqhIsX8fXX+O032Ntj4UKIe9kMEf0N+RZiTU9CfE4ODg5hYWFr166Nj4/v3LnznDlzHj58KNroDRvi448RH48BAzBvHtq3x8qVKC0VbXwiehq5F+JLf8tcDYVCMX78+MTExLFjxy5atMjR0XHfvn1ibqBNG+zZg7NnYWeHKVPQoQPWrOHSikS1R+6FWGszxCotWrRYs2bN2bNnmzdv7u/v7+fnd+3aNTE34OWFsDAcPIiWLTFpElxccPiwmOMT0X+xEMXh4eFx4cKFoKCgU6dOdezYcf78+SJf2TJ4MCIisHcvKiowaBCGDRNuF0NE4pF1Ierpwdi4zjaoo6Pz3nvvJSYmjhw58vPPP3dwcNi1a5fI2/DzQ0wMvvwSYWFwdsaKFbzgj0hEsi5EMzMoFHW8WXNz8/Xr16tvYvXaa6/16dMnOjpazA3o6uKTTxAXh27dMHUqevRAYqKY4xPVY/ItxFu3avUblep5eHicP39+7dq1V69e7dKly/jx43NycsTcgLU1jhzBxo1ISYGrKz79FOLuoRPVS7IuxJYtJdy+UqkcP358UlLSjBkzNm3aZGdn99VXX4l5YFGhwD/+IawN8cUXcHbmxS1EL0nWhVijhb/EZWxs/P3338fGxvbu3fvf//63g4PDtm3bxLy4xcwMW7fi5EkYGsLPDwMH4uJF0QYnqmfkW4h5edLOEB9nb28fEhJy+PBhQ0PDUaNG9ejRIzIyUswN9O6NqCj85z9ITETXrggIgLgHLonqB5kW4r17KC7WhBni4wYOHBgdHb1y5crff//dw8Nj9OjR169fF210pRLvvIPkZCxejDNn0KUL3ngDv/8u2vhE9YBMCzEvD4DmzBCr6OjovPvuu8nJyR999FFwcLC9vf2sWbPu3Lkj2gb09DBrFlJTMWcO9u2DoyOmT4eI4xPJmkwL8dYtQBMLUc3IyOjrr79OTU2dMGHC8uXLbWxsvvjiCzHXnTUywhdfICUFb7+NFStga4vly3nNH9EzyboQNWyX+Qnm5ubLly9PTEwcMmTIvHnz2rVrFxQUVFJSItoGVCqsXo0LF+DggBkz0KsXRL9bFpG8yLQQNXWX+a/atm37yy+/XLhwwdnZ+f3337ezs1u3bl15ebloG3Bzw+nT+PVXZGTAwwPjx+PGDdEGJ5IXmRaiNswQH+fu7h4aGnr06FFzc/N33nnHyclpy5YtFWJdlqdQ4I03kJSEuXOxZQvs7fHvf+P+fXEGJ5IRmRZiXh6MjNCokdQ5Xkz//v0jIiL27Nmjq6v75ptvOjs7b9u2TbRa1NfHggVISkJAAL7+Gu3aYelSLj1L9DiZFqLUl6nUmEKhCAgIiImJ2blzp46OzqhRozp37rxz507RarF1a2zZgvPn4eKC2bPRti2Cgrj0LJGafAtRe/aX/0qhUIwYMSImJmb79u2VlZWBgYGurq5i1mLXrjhyBOHhcHLC++/D1ZWX/RFBtoWoSZep1JhSqQwMDIyNjd26dWt5eXlgYKCTk9OmTZvKxDqBxtMTx48jJASlpfDzw7BhEPFEcSItJNNC1PIZ4uOUSuXrr78eGxu7e/fuxo0bjxkzxt7efs2aNY8ePRJnA0OGIC4Oixbh1Cl07IhFi7gHTfWWHAuxshL5+TKYIT5OqVQOHz784sWLBw8eNDc3nzRpUvv27YOCggpF+VZEVxf/+heuXsXgwfjoI3TpgogIEYYl0jZyLMSCApSWymaG+ITBgwefOXPmxIkT9vb277//vrW19WeffZanPu/yJVlaYudO7NuHu3fh7Y2pU3nNH9U3cixEzb5uTxQ+Pj5Hjhy5ePHigAEDvvzyyzZt2kyfPj0tLU2EoYcNw5Ur+OADrF0LW1usWAERzxIn0mxyLETtuUzlJbm5uW3ZsiUlJWXcuHHr1q2zs7MbNWqUCAuLGRhg8WLExqJ7d0ydCjc3HDokRl4iTSfHQtS2y1ReUtu2bZcvX379+vW5c+ceO3ase/fu3t7eO3fufNnr/+ztcfAgDh7Eo0cYPBj9+uHMGZEiE2koORZivZkhPs7U1HT+/PnXr1//4YcfcnJyAgMD27dvv2zZsnv37r3UuIMHIzYWP/yA+Hj07Alvb94VmmRMjoV46xaUSpiYSJ1DAgYGBjNmzEhOTt62bZu5ufmsWbNat249c+bMa9eu1XzQhg0xYwZSU/Htt0hLw6BB6N4dO3bw2CLJjxwLMS8PzZqhQQOpc0imQYMGI0eOPHfu3Llz53x9fX/66SdbW9sRI0aEhYXVfNAmTfDhh7h+HWvX4uFDjByJ9u3x3Xd4yRkokSZRiHnDIw3x+uuIi8PVq1Ln0BQ5OTlr1qxZtWpVdna2s7PztGnT3nrrLQMDg5qPWFmJw4fxxRc4exZGRpgyBR98UH8O2pKMybEQ+/RBRQVeZjYkR6WlpcHBwT/99FNYWJihoeHo0aMnTZrk4uLyUoOePYtlyxAcjEaN8I9/YNYs2NmJlJdIAnIsRCcnODhgxw6pc2io+Pj4n376afPmzQ8ePOjWrdukSZNGjRr1UhPG1FR88w02bkR5OcaOxWefwcpKvLxEdUeOxxC1du2vuuHk5LRixYrMzMygoKAHDx5MmDBBpVJNmTIlJiamhiO2a4c1a5CcjEmTsHkzbG0xdSpyckRNTVQXZFeI5eW4fZvHs57JyMjovffeu3LlyunTp/39/Tds2ODq6tqtW7e1a9fW8Ppoa2v8/DNSUzF+vHCVy9y5uHtX7OBEtUh2hXj7NioqOEN8fj169Ni4cWNWVlZQUNDDhw8nTpyoUqmmTp0aXbNb3bdqhZ9/xtWrGDYMX32Fdu2wbBlEvHMWUW2SXSHWs8tUxNKsWbP33nsvPj7+7Nmzw4cPX79+vZubm7u7+48//liT20a3b48tWxAVBXd34ZuWNWsg1nplRLVGdoVYLy9TEZGXl9f69euzs7OXL1+uUCjee+89lUo1YsSIPXv2vPAtUt3ccPgwjh2DSoVJk2Bnh40bIdai30S1QHaFyBmiGIyNjadNmxYVFRUbGztt2rSIiIhXX33VwsJi8uTJES+6VGLfvjh3DocPo2VLjB2Ljh2xaRPEWvSbSFQyLUTOEEXi7Oy8dOnS9PT0o0eP+vv7//rrr56eno6Ojt98882LXQ44cCDOn8eePWjcGGPGwMEB69dzaW7SNLIrxLw8NGiA5s2lziErOjo6/fv3X7duXU5Ozvr161u2bPnJJ5/Y2Nh069ZtyZIlWVlZzzWKQoGAAFy8iP370aIFxo2DtTUWL+YdoklzyO7E7MmTERyM3Fypc8jcjRs3fv31119++eXKlStKpdLHx2f06NHDhw9v1qzZ8w5x9CgWL8bRozA2xoQJmDQJtra1GZno2WRXiK++it9/R2ys1Dnqi7i4uO3bt2/fvj05OVlXV3fAgAEjR4709/c3MjJ6zvfj++/xyy949AiDBmHmTPTvD4WillMTPZ3sCtHLC02a4MgRqXPUO5cvX96+ffuOHTtSUlIaNWo0cODAkSNH+vn5GRoaPvvNN2/i55+xYgXy8uDsjPffx+jRaNSo9lMT/Q/ZFaKNDXr0wMaNUueov6Kjo3fs2LF9+/bU1FQ9Pb1BgwaNHDly6NChTZs2fcY7i4qwaRO++w6JiTA3x7/+hXffxctcZE30gmRXiPr6mD4dixZJnYNw8eJFdTNeu3ZNT0+vf//+AQEBfn5+ptWfFFVZiYMHsWwZjh+HqSk++ADTpuGZZUokBnkV4t27MDbG0qX44AOpo9CfoqKidu/eHRwcnJCQoKOj4+3tPXz48ICAgDZt2lT/NixciP370awZpk3DtGkwM6ujxFRfyasQk5Jgb49ffsGbb0odhZ4iKSlpz549wcHBkZGRlZWVTk5OQ4YM8fX19fb21tHRefp7Ll/G119j1y7o6OCttzB9Ol5yDUeivyevQgwLg48Pjh1D375SR6HqZGVl7du3b8+ePSdPniwtLW3evPnAgQOHDh06aNCgFi1aPOUN6en48UesXYs//kD37nj3XQQGokmTOg9OMievQty2DaNG4coVODpKHYWeyx9//PHbb7+FhIQcOnTozp07Ojo6Hh4eQ4YMGTJkSKdOnZ589YMHWLcOK1YgIQEGBhg+HJMmoWdPKYKTPMmrEIOC8P77uH2bV6ponfLy8nPnzh04cODAgQNxcXEArKysfH19fX19+/Tp0+SJyWB4ODZuxKZNePgQjo4YPx6jRkGlkiY6yYi8CnHOHHz3HYqKeGavVktPTz948GBISMjx48eLiooaNmzo5eX1yiuv+Pr6du7c+c/XPXiAnTuxejXOnYNSCX9//POf6NWL//apxuRViOPG4fhx3LghdQ4SR1FR0alTp44ePXrkyBH1tLF169a+vr59+/bt3bu3WdWXzsnJ+L//w+rVKCiAvT2mT8fbb/MERqoBeRXi4MEoKMCLrk9F2iAnJ0fdjKGhoTdv3gTg6Og4YMCAgQMH9u7d28DAAMXF2LULy5bh0iU0b45338WMGbCwkDo4aRN5FaKrK6ytERwsdQ6qRZWVlZcvXz5y5MjRo0fPnDlTXFysq6vr4eHRp08fHx8fDw8PvYgILFuGAwfQoAH8/DBlCnx8oJTdwk5UC+RViBYW8PfHypVS56A6UrVPfeLEiZiYmIqKCj09PQ8PDx8fH98OHdwuXdLZtAm5ubCywjvvYPRotG8vdWTSaDIqxPJyNGqEuXMxf77UUUgCBQUFp0+fPnHixMmTJ2NjYysqKho3btzL03OCmVn/tDTjqChUVMDDA6NGISCAd46mp5JRIebkQKXCihWYPFnqKCSxO3funDp1Sl2O8fHxFRUV7fT1Z7du7Xf/vio7GwoFPD0xahT8/dmM9DgZFWJUFLp2RXAw/P2ljkIapKCgIDw8PDw8/PTp05GRkeYlJa8pleP19BwePoRC8cjdXXf8eLz5Jp5nmTKSOxkV4u7dGDECFy/CzU3qKKShioqKwsPDw8LCzpw5czciYnhR0WigLVDSoEFq166YOLH96NG6urpSxyTJyKgQv/8eM2ciLw8mJlJHIS1QVlYWHR0dfvZs/t69dhcu+BYWtgBiFYrD1tYFvr5d+vXz8vIyNzeXOibVKRkV4qxZWLkShYVS5yCtlJmamv3TT6Y7drTNzCwEtgI/AgVWVl27du3evXvXrl3d3d2fvcYtaTkZFWJgIOLjkZAgdQ7SclFRFcuXY9s2ZXHxVTOz1QrFitzcR4COjo69vX23bt26du3arVs3Z2dn7lzLj4wKsXt3GBvj8GGpc5As3L6NVauwejVu3KgwMbnep89BS8sjqamRkZHq62QaNmzYsWNHFxcXV1dXFxeXzp07P+99tUiDyagQLSwwdCjWrJE6B8lIRQUOH8bq1QgJQXk5evTAG29kdely7saN6Ojo6OjomJiYnJwcAAqFom3btupyVGvVqpXU6emFyaUQS0rQuDHmz8e8eVJHITnKzsamTfj1V8TGQqlEt24ICEBAADp0uHnzZkxMTExMzMWLFyMjI2/8d20RExMTV1fXqoq0s7P721XBSWPIpRB//x22tli3Dm+/LXUUkrX4eGzbhr17ERcHAG3aYNAgBASgVy80bgzg1q1bUVFRMf+VlpZWXl4OQF9f39nZWb1z7eDg4OTkZMLTITSPXArx+HH068ebB1DdSU3FgQMIDcXJk7h/H3p68PZG//4YNgwdO1a9qri4OCEh4erVq+p+jI6Ovn37tvqpli1bOjk5OTo6qn/v2LFjcy5sLDW5FOL69Rg3DikpvHqf6lpZGSIicPQoQkJw6RIAtGmDAQMwbBj691dPGx+Xm5t75TFXr14tKChQP2VhYdHxMY6OjsbGxnX8t6nn5FKIn3+O+fNRVIRGjaSOQvVYVpbQjIcOobAQBgYYNAj+/hgypJrbWmRmZqq/n4mLi0tJSUlOTn748KH6qVatWnXo0MHW1tbW1tbR0dHBwcHa2rqu/jL1kVwKceJEhIQgJ0fqHEQAgKIihIYiOBj79yMvDw0aoFcvBARgyBDY2Dzz3RkZGQkJCXFxcQkJCfHx8QkJCffu3VM/ZWhoaG9vb2trW1WUtra2hrwQWyRyKcS+fVFSgrNnpc5B9L/KyxEejr17ERKCpCQAaNdOmDN6ez//Ds2NGzeSk5PV80f1g+vXr5eVlamfNTc3t7Ozs7W1rfq9ffv2jbi39OLkUogWFhgyBGvXSp2D6O+lpyMkBCEhOHUKhYXQ10fPnujfH/37w9kZL3hSTmlp6bVr15L/KyUlJSUlJTMzU/2JViqVKpWqTZs2bdu2tbGxsbOzs7Oza9euXbNmzWrn7yYTsijEggI0b44lSzBrltRRiJ5DSQlOnEBICI4dQ2IiADRtiu7d4eWFvn3h4VHjQ+FFRUVV5Vg1nczLy6t6gbGxsbol1fvadnZ2bdu2tbS0VPIWCwBkUojh4fD2xoED8PWVOgrRC8rPx5kzOHYMZ84gPh5lZWjUCO7u8PCApyc8PWFp+ZJbePDgwfXr169du5aamqpuydTU1IyMjKo9bl1d3datW7f5LysrK5VKpVKprKysnrwjttzJohD/8x9MmIDU1Oc5XE2kue7excmTOH0aERG4eBHFxQBgZSU0o4cHXF0h0ooSZWVlmZmZN27cUHdl1e9ZWVnqM8nVTExM2rZtW9WV1tbWrVq1srCwaNmypSgxNI0sCnHWLKxYgQcPeGc1ko/SUly6hIgIREQgPBzp6QDQoAHs7YWdaw8P2NuL/t98aWlpZmbm9evXHy/K9PT03NzcR48eVb2sUaNG1tbW6pa0tLRs3bq1hYVFq1atVCqVVp9eLotC9PVFTg6io6XOQVRrsrOFZoyKQmws1OdyGxsLe9b9+qFbNzRsWKsRcnNzs7Ky1F1548aNzMzMnJycjIyMmzdvVu19A2jcuLF6Fvl4S6pUKvUfaviaabIoxLZt4emJX3+VOgdRXUlKQkQEzp1DeDiuXkV5ORo3hrs7PD2FyWMdrvVdUVGh7kp1P+bk5GRmZmZnZ2dlZWVlZd29e/fxF5uZmalUKktLS0tLSzMzM1NTU1NTU5VKZWFhYWlp2fgvF/bUMe0vxMJCGBpi/nx8+qnUUYikcOcOTpzA2bPCkUf1jq2NDTw90bkz3Nzg5gbpzrZ5+PDhEy35+NSytLT08Re/9tprO3bskCoq5FCIkZHo3h27d2P4cKmjEEmtpEQ48njuHM6dQ2am8OetW8PZGZ06oVMnODujQ4fa3r9+HpWVlbm5udnZ2bm5ufn5+Xl5eY6Ojr6Sniui/YW4dCn+9S9kZ9flPgKRdsjNRVwcYmMRF4e4OFy5gpISANDVhb09bGzg4CBUpK2tWN9fazXtL0R/fyQlCWe3ElE1ysqQkoK4OFy+jIQEpKUhMVGoSKUSVlZwdoazM5ychK6sf5dIa3khVlTAxASvvYbVq6WOQqSFysqQnCzMItUVmZCAqtNrrK1hYwMbG7Rvj06dYGcHa2tN2NeuPVpeiJcvw8UFmzbhrbekjkIkC2VlSEpCfDx+//3PB/fvC8/q6KB1a6Elq7qyY0fo6UkaWjQNpA7wck6dAoDevaXOQSQXDRqgY8fHF/0GgLw8pKUhNRVpacKv335DVpbwrI4OrKz+pyXVv7TwDG0tnyEOHoykJKSlSZ2DqP65dw9JSUhJESpSXZdZWaiqlCZNoFLBygpWVlCpYGqKli1hYSE80MhbymhzIV67hvbt8cknWLhQ6ihEBAAoKcG1a39OJNPScOsWcnNx8yb+uwy4oGFDoSvVFWlmBnNztGz5Z2lKsZ6jNhfinDlYvBhpabCykjoKET1LYSEyMoSKzMnBrVt/duW1a0/WJQAjo//pyscfWFmhdm57rbWFWFICKyt07459+6SOQkQv7fZt3LyJvDyhIgsKhF95eUJ7Zmf/+eJevRAWVhsptPZLlQ8/RF4eZs6UOgcRiaFFC7RoUd0LitVXymUAAAbfSURBVIuRno68PBQVoUFtFZd2zhDVCyDOno3Fi6WOQkTyoYWFOHw4goPRuzeOHpX3OaJEVMe0cEXVS5ewaBFCQ9mGRCQuLZwhVlRwZWwiqg1aWIhERLWDUy0iIgELkYhIwEIkIhJo7YnZ1Xr11VevXbumo6MjdZCaePTo0d27d01NTaUOUkPZ2dkWFhYKhULqIDVRXFxcWFjYovozhDVYVlaW5Uvf2F4qDx8+fOuttz755BMJM8izEA0MDPbv39+qdq52rG1xcXFr1qz54YcfpA5SQ0OHDt22bZuBgYHUQWri1KlTx44dW7BggdRBaqhPnz4nTpyQOkUN7d27N03qlau4y0xEJGAhEhEJWIhERAIWIhGRgIVIRCSQZyEqlUql1l7vrKOjo73hoeX5tTo8gIbavOKJjo6O5KfKyfNa5pKSkkZS3JBBLFqdX6vDV1ZWlpaW6urqSh2khrT6h19RUVFeXi5tp8uzEImIakCL9w6IiMTFQiQiErAQiYgELEQiIgELkYhIwEIkIhKwEImIBFpfiFFRUW5ubs2aNRs3blxRUdELPasJqk8YGhrq4uJiYGDQo0ePK1euSJKwGs/z401MTGzSpEkdB3tO1efPycnx9fU1NDT08PBISkqSJGE1qg+/atWqNm3a6Ovr+/j4JCYmSpLwefj6+j41nmSf3EptVlpaam1tvWbNmszMzH79+n355ZfP/6wmqD5hdnZ2kyZNtm/f/scff8ydO9fR0VGqnE/1PD/esrIyT09PHR2duo/3TNXnr6iocHNzW7JkSU5OzsyZM318fKTK+VTVh09JSWnYsGFoaGhOTs60adP69OkjVc5qhIaGTpgwAUBCQsITT0n4ydXuQgwNDbW3t1c/PnHihK2t7fM/qwmqT7h161YPDw/145KSEoVCcefOnbqO+Pee58f73XffBQYGamYhVp8/MjLS3t6+oqKisrKyuLj48uXLEkT8e9WHz87Obtq0aURExL1792bPnj1ixAgpMj7D4sWLp02bpq+v/9dClPCTq923ELh+/bqzs7P6sbOz840bNyorK6vu5lH9s5qg+oS+vr59+vRRP46IiGjTpo2xsbE0QZ/mmT/e1NTUlStXHjx4cPfu3RJlrE71+a9cudKhQ4d333335MmTnTp1+u6776RL+hTVh7ewsPj22289PDwUCkXz5s01cH8fwOzZswEEBwf/9SkJP7nafQwxPz+/adOm6seGhoaPHj26f//+cz6rCapP2LRp05YtW1ZWVu7du/fNN98MCgrSqDavPnxFRcXEiROXLl1qaGgoUcBnqD5/Xl7evn37XF1dQ0JCzMzMXn/9dYliPl314RMTExcuXBgeHl5YWPjOO++MGzdOopg1JOEnV7tniM2aNXvw4IH68b179xo0aPD48fvqn9UEz0x4+/btiRMnpqenBwcHd+nSRYqMf6v68GvXrlWpVEOGDMnPz5co4DNUn19fX79Xr15TpkwBsGTJkqZNm+bn55uYmEiT9S+qD79//35fX19PT08ACxcuNDIyunv3rpGRkTRZX5yEn1ztniHa2NhUffeakJDQpk2bxxezq/5ZTVB9wpKSkoEDBzo4OJw/f17T2hDPCn/8+PF9+/aZmJjY2dmVl5ebmJhERERIlPTpqs9vbW1d9VipVCoUigYNNGj2UH348vLy8vJy9ePKysry8vJKrVrUSspPbp0drawNpaWlKpVqx44d9+/f9/Pzmz9/vvrPd+zYkZmZ+XfPao7q82/durVz587XHlNWViZt4MdVHz4/Pz8jIyMjI+Py5ctKpTIjI6O4uFjawE+oPn9xcbGZmdnmzZvz8/NnzpzZu3dvScM+qfrw8fHxRkZGR48ezc/PnzFjhmZ+y6xmaWn5+Jcqkn9ytbsQKysrL1y40Llz5+bNm7/99ttVHzn1fZn/7lmNUk3+Dz/88In/e+Xl5Umb9gnV//DV8vLyNPNb5spn5T9//rybm1uTJk0GDx6ckZEhadKnqD78rl27OnTo0LRp02HDhmVmZkqatDpPFKLkn1wuEEtEJNCsY2pERBJiIRIRCViIREQCFiIRkYCFSEQkYCESEQlYiEREAhYiEZGAhUhEJGAhEhEJWIhERAIWIhGRgIVIRCRgIRIRCViIREQCFiIRkYCFSEQkYCESEQlYiEREAhYiEZGAhUhEJGAhEhEJWIhERAIWIhGRgIVIRCRgIRIRCViIREQCFiIRkYCFSEQkYCESEQlYiEREAhYiEZGAhUhEJGAhEhEJWIhERAIWIhGRgIVIRCRgIRIRCViIREQCFiIRkYCFSEQkYCESEQlYiEREAhYiEZGAhUhEJGAhEhEJWIhERIL/B0M5yYHofnFUAAAAAElFTkSuQmCC" alt="plot of chunk unnamed-chunk-7" /></p>
</div>
<div id="confidence-interval-about-the-overall-mean" class="section level2">
<h2>Confidence interval about the overall mean</h2>
<div id="frequentist-method" class="section level3">
<h3>Frequentist method</h3>
<p>There’s a <a href="http://stla.github.io/stlapblog/posts/ModelReduction.html">straightforward way to get a confidence interval</a> about the overall mean <span class="math">\(\mu\)</span>: just take the group means and draw a usual Gaussian confidence interval about their mean:</p>
<pre class="r"><code>by(dat, dat$data, function(data){
  aggregate(y~group, data=data, FUN=mean) %&gt;% lm(y~1, .) %&gt;% confint
  })
## dat$data: dat1
##                2.5 %   97.5 %
## (Intercept) 4.304683 13.03132
## -------------------------------------------------------- 
## dat$data: dat2
##                2.5 %   97.5 %
## (Intercept) 8.419673 11.37769</code></pre>
</div>
<div id="bayesian-method" class="section level3">
<h3>Bayesian method</h3>
<p>Throughout the article we always use equi-tailed credible intervals.</p>
<pre class="r"><code>quantile(sims[&quot;data1&quot;]$mu, c(2.5,97.5)/100)
##     2.5%    97.5% 
##  4.29467 13.03949
quantile(sims[&quot;data2&quot;]$mu, c(2.5,97.5)/100)
##      2.5%     97.5% 
##  8.242078 11.563506</code></pre>
<p>For the first dataset, the Bayesian interval is close to the frequentist interval. We can see why: when <span class="math">\(R(SS_w,SS_b)=0\)</span>, the posterior distribution of <span class="math">\(\eta_b\)</span> is <span class="math">\(\eta_b \sim {\cal IG}\left(\frac{I-1}{2},\frac{SS_b}{2}\right)\)</span> and then the posterior distribution of <span class="math">\(\mu\)</span> is a non-standardized Student distribution with <span class="math">\(I-1\)</span> degrees of freedom, location parameter <span class="math">\(\bar y_{\bullet\bullet}\)</span>, and scale <span class="math">\(\sqrt{\frac{SS_b}{IJ(I-1)}}\)</span>. Therefore the Bayesian interval <em>exactly</em> coincides with the frequentist interval when <span class="math">\(R(SS_w,SS_b)=0\)</span>, and this is the case for the first dataset. Otherwise, when <span class="math">\(R(SS_w,SS_b)=0\)</span>, the Bayesian interval is wider.</p>
<p><em>Yes, probabilists, I know <span class="math">\(R(SS_w,SS_b)\)</span> is never exactly <span class="math">\(0\)</span> !</em></p>
</div>
</div>
<div id="confidence-interval-about-variance-components" class="section level2">
<h2>Confidence interval about variance components</h2>
<div id="frequentist-method-1" class="section level3">
<h3>Frequentist method</h3>
<p>The <span class="math">\(\chi^2\)</span> distribution of <span class="math">\(SS_w\)</span> easily allows to derive a confidence interval about the within-variance <span class="math">\(\sigma^2_w\)</span>. By the way it is the same as the case of the fixed effects model.</p>
<p>Things are more complicated for the between-variance <span class="math">\(\sigma^2_b\)</span> and the total variance <span class="math">\(\sigma^2_w+\sigma^2_b\)</span>. The function <code>confintVC</code> below provides confidence intervals following the method given by <a href="/" title="R.K. Burdick, C.M. Borror, D.C. Montgomery. *Design and analysis of gauge R&amp;R studies*. ASA-SAM Series on Statistics and Applied Probability 2005.">Burdick &amp; al</a>, based on <a href="/" title="F.A. Graybill, C-H. Wang. *Confidence intervals on nonnegative linear combination of variances*. Journal of the American Statistical Association 75:372, 869–873, 1980.">Graybill &amp; Wang</a>’s confidence intervals for linear combinations of <span class="math">\(\chi^2\)</span> distributions.</p>
<pre class="r"><code>confintVC &lt;- function(y, group, alpha=5/100){
  group &lt;- factor(group)
  I &lt;- length(levels(group))
  if(!all(I*as.numeric(table(group))==length(y))){ stop(&quot;balanced only!&quot;) }
  J &lt;- length(y)/I
  #
  DFb &lt;- I-1 # between df
  DFw &lt;- I*(J-1) # within df
  SS &lt;-  SOS(y, group) # sums of squares
  SSb &lt;- SS$SSb; SSw &lt;- SS$SSw
  MSSb &lt;- SSb/DFb; MSSw &lt;- SSw/DFw # mean sum of squares
  # Confidence Intervals 
  a &lt;- alpha/2
  ## Within variance confidence interval  
  sigma2w &lt;- MSSw # estimate
  withinLCB &lt;- sigma2w/qf(1-a,DFw,Inf)  # Within lwr 
  withinUCB &lt;- sigma2w/qf(a,DFw,Inf) # Within upr
  ## Between variance confidence interval
  sigma2b &lt;- (MSSb-MSSw)/J # estimate
  G1 &lt;- 1-(1/qf(1-a,DFb,Inf)) 
  G2 &lt;- 1-(1/qf(1-a,DFw,Inf)) 
  H1 &lt;- (1/qf(a,DFb,Inf))-1  
  H2 &lt;- (1/qf(a,DFw,Inf))-1  
  G12 &lt;- ((qf(1-a,DFb,DFw)-1)^2-(G1^2*qf(1-a,DFb,DFw)^2)-(H2^2))/qf(1-a,DFb,DFw) 
  H12 &lt;- ((1-qf(a,DFb,DFw))^2-H1^2*qf(a,DFb,DFw)^2-G2^2)/qf(a,DFb,DFw) 
  Vu &lt;- H1^2*MSSb^2+G2^2*MSSw^2+H12*MSSb*MSSw  
  Vl &lt;- G1^2*MSSb^2+H2^2*MSSw^2+G12*MSSw*MSSb  
  betweenLCB &lt;- (MSSb-MSSw-sqrt(Vl))/J # Betwen lwr
  betweenUCB &lt;- (MSSb-MSSw+sqrt(Vu))/J  # Between upr  
  ## Total variance confidence interval
  sigma2tot &lt;- sigma2w+sigma2b   # estimate
  totalLCB &lt;- sigma2tot - (sqrt(G1^2*MSSb^2+G2^2*(J-1)^2*MSSw^2)/J) # Total lwr 
  totalUCB &lt;- sigma2tot + (sqrt(H1^2*MSSb^2+H2^2*(J-1)^2*MSSw^2)/J)  # Total upr  
  # Output
  out &lt;- data.frame(
    estimate=c(sigma2w, sigma2b, sigma2tot),
    lwr=c(withinLCB, betweenLCB, totalLCB),
    upr=c(withinUCB, betweenUCB, totalUCB))
  rownames(out) &lt;- c(&quot;within&quot;, &quot;between&quot;, &quot;total&quot;)
return(out)
}</code></pre>
<pre class="r"><code>with(dat1, confintVC(y, group)) 
##          estimate       lwr        upr
## within  0.9678172 0.5281232   2.318259
## between 2.9238944 0.6600113 121.680179
## total   3.8917116 1.6132104 122.670629
with(dat2, confintVC(y, group))  
##          estimate        lwr       upr
## within  1.1487720  0.6268675  2.751709
## between 0.1630157 -0.2117912 13.789360
## total   1.3117877  0.8059042 15.023651</code></pre>
<p>The same estimates are provided by <code>lmer(y~group)</code> with the <code>lme4</code> package for mixed-models.</p>
</div>
<div id="bayesian-method-1" class="section level3">
<h3>Bayesian method</h3>
<p>First, let us construct the simulations of the total variance:</p>
<pre class="r"><code>sims[, &quot;sigma2tot&quot;:=sigma2w+sigma2b]</code></pre>
<p>Let’s see the estimates before looking at the credible intervals:</p>
<pre class="r"><code>sapply(sims[&quot;data1&quot;, c(&quot;sigma2w&quot;, &quot;sigma2b&quot;, &quot;sigma2tot&quot;), with=FALSE], function(x) c(mean=mean(x), median=median(x)))
##         sigma2w   sigma2b sigma2tot
## mean   1.116632 40.565856 41.682488
## median 1.012645  4.268724  5.408561</code></pre>
<pre class="r"><code>sapply(sims[&quot;data2&quot;, c(&quot;sigma2w&quot;, &quot;sigma2b&quot;, &quot;sigma2tot&quot;), with=FALSE], function(x) c(mean=mean(x), median=median(x)))
##         sigma2w   sigma2b sigma2tot
## mean   1.248280 6.1369897  7.385270
## median 1.144814 0.4706216  1.794074</code></pre>
<p>Clearly, the median is a better estimate than the mean. Now let’s have a look at the credible intervals.</p>
<p>For the first dataset, the confidence interval about the within-variance is the same as the frequentist confidence interval, as expected, and it is interesting to see that the credible interval is close to the frequentist confidence interval for the other variances:</p>
<pre class="r"><code>sapply(sims[&quot;data1&quot;, c(&quot;sigma2w&quot;, &quot;sigma2b&quot;, &quot;sigma2tot&quot;), with=FALSE], function(x) quantile(x, c(2.5,97.5)/100)) 
##         sigma2w     sigma2b  sigma2tot
## 2.5%  0.5282047   0.6471158   1.636684
## 97.5% 2.3164339 121.5854008 122.691925</code></pre>
<p>For the second dataset, it is not expected to get results close to the frequentist results. We get a shorter interval for the within-variance, and wider intervals for the other variances:</p>
<pre class="r"><code>sapply(sims[&quot;data2&quot;, c(&quot;sigma2w&quot;, &quot;sigma2b&quot;, &quot;sigma2tot&quot;), with=FALSE], function(x) quantile(x, c(2.5,97.5)/100))
##         sigma2w     sigma2b sigma2tot
## 2.5%  0.6109852  0.01482579  0.810674
## 97.5% 2.4954109 17.13539103 18.486391</code></pre>
</div>
</div>
<div id="confidence-interval-about-coefficient-of-total-variation" class="section level2">
<h2>Confidence interval about coefficient of total variation</h2>
<div id="frequentist-method-2" class="section level3">
<h3>Frequentist method</h3>
<p>A confidence interval about the coefficient of total variation <span class="math">\(\dfrac{\sqrt{\sigma^2_w+\sigma^2_b}}{\mu}\)</span> is provided by the function <code>ranovaCV</code> below. The method is based on the generalized <span class="math">\(p\)</span>-value approach using a generalized pivotal quantity. The procedure performed by this function is an original one: I did it myself, but I don’t really know how: I have naively followed a procedure given in <a href="/" title="Kalimuthu Krishnamoorthy, Thomas Mathew. *Statistical Tolerance Regions: Theory, Applications, and Computation*. Wiley 2009.">Krishnamoorthy &amp; Mathew</a>’s book for another parameter of interest.</p>
<pre class="r"><code>ranovaCV &lt;-  function(y, group, level=0.95, nsims=100000){
  group &lt;- factor(group)
  I &lt;- length(levels(group))
  if(!all(I*as.numeric(table(group))==length(y))){ stop(&quot;balanced only!&quot;) }
  J &lt;- length(y)/I
  SS &lt;-  SOS(y, group) # sums of squares
  SSb &lt;- SS$SSb; SSw &lt;- SS$SSw
  Z &lt;- rnorm(nsims)
  Ub &lt;- rchisq(nsims, I-1)
  Ue &lt;- rchisq(nsims, I*(J-1)) # ! J*(I-1) in K &amp; M's book is an error
  mu.gpq &lt;- mean(y)-Z/sqrt(Ub)*sqrt(SSb/I/J)
  sigmatot.gpq &lt;- 1/sqrt(J)*sqrt(SSb/Ub+(J-1)*SSw/Ue)
  G &lt;- sigmatot.gpq/mu.gpq
  low &lt;- as.numeric(quantile(G,(1-level)/2)) # borne inf
  up &lt;- as.numeric(quantile(G,level+(1-level)/2)) # borne sup
return(list(lwr=low, upr=up))
}</code></pre>
<pre class="r"><code>
with(dat1, ranovaCV(y, group)) # true value : sqrt(5)/10 ≃ 0.224
## $lwr
## [1] 0.1403256
## 
## $upr
## [1] 1.488213
with(dat2, ranovaCV(y, group)) # true value : sqrt(2)/10 ≃ 0.1414
## $lwr
## [1] 0.08956391
## 
## $upr
## [1] 0.3931898</code></pre>
</div>
<div id="bayesian-method-2" class="section level3">
<h3>Bayesian method</h3>
<p>Similarly to any other parameter of interest, one firstly constructs the simulations of the coefficient of total variation:</p>
<pre class="r"><code>sims[, &quot;CV&quot;:=sqrt(sigma2tot)/mu]</code></pre>
<p>and then one takes the quantiles:</p>
<pre class="r"><code>sims[, list(lwr=quantile(CV, 2.5/100), upr=quantile(CV, 97.5/100)), by=&quot;data&quot;]
##     data        lwr       upr
## 1: data1 0.14091359 1.4463289
## 2: data2 0.09033098 0.4414735</code></pre>
</div>
</div>
<div id="prediction-interval" class="section level2">
<h2>Prediction interval</h2>
<div id="frequentist-method-3" class="section level3">
<h3>Frequentist method</h3>
<p>This method is given in <a href="/" title="Lin Liao. *Prediction intervals for the general balanced linear random models*. Journal of Statistical Planning and Inference 138, 3164-3175, 2008.">Lin &amp; Liao</a>. Denote by <span class="math">\(y^{\text{new}}\)</span> a new observation. Note that <span class="math">\[
y^{\text{new}} - \bar{y}_{\bullet\bullet} \sim 
{\cal N}\left(0, \sigma^2_{\text{tot}} + \frac{\tau^2}{I}\right),\]</span> and the variance of <span class="math">\((y^{\text{new}} - \bar{y}_{\bullet\bullet})\)</span> can be written<br /> <span class="math">\[
  \left(1+\frac{1}{I}\right)\tau^2 + \left(1-\frac{1}{J}\right)\sigma^2_w. 
 \]</span> Then knowing that <span class="math">\(SS_w \sim \sigma^2_w\chi^2_{I(J-1)}\)</span> and <span class="math">\(SS_b \sim J\tau^2\chi^2_{I-1}\)</span>, an unbiased estimate of the variance of <span class="math">\((y^{\text{new}} - \bar{y}_{\bullet\bullet})\)</span> is <span class="math">\[
  \left(1+\frac{1}{I}\right)\frac{SS_b}{J(I-1)} + \left(1-\frac{1}{J}\right)\frac{SS_w}{I(J-1)} 
   = \frac{I+1}{I(I-1)}\frac{SS_b}{J} + \frac{SS_w}{IJ} 
 \]</span> This estimate does not follow a Chi-square distribution but we assimilate it as an approximate Chi-square distribution using Satterthwaite estimate. In addition, since we know (or <a href="http://stla.github.io/stlapblog/posts/Anova1random.html">as shown here</a>) that <span class="math">\(SS_b\)</span>, <span class="math">\(SS_w\)</span> and <span class="math">\((y^{\text{new}} - \bar{y}_{\bullet\bullet})\)</span> are independent, <span class="math">\[
\dfrac{y^{\text{new}} - \bar{y}_{\bullet\bullet}}{\sqrt{\dfrac{I+1}{I(I-1)}\dfrac{SS_b}{J} + \dfrac{SS_w}{IJ}}} \approx \mathrm{t}_\nu,
\]</span> wherefrom we get a prediction interval about <span class="math">\(y^{\text{new}}\)</span>.</p>
<pre class="r"><code>ranovapred &lt;- function(y, group, conf=0.95){
  group &lt;- factor(group)
  I &lt;- length(levels(group))
  if(!all(I*as.numeric(table(group))==length(y))){ stop(&quot;balanced only!&quot;) }
  J &lt;- length(y)/I
  SS &lt;-  SOS(y, group) # sums of squares
  SSb &lt;- SS$SSb; SSw &lt;- SS$SSw
    a &lt;- (1/J*(1+1/I))/(I-1)
    b &lt;- 1/I/J 
    v &lt;- a*SSb+b*SSw # estimates the variance of (Ynew-Ybar)
    nu &lt;- v^2/((a*SSb)^2/(I-1)+(b*SSw)^2/I/(J-1)) # Satterthwaite degrees of freedom
    alpha &lt;- 1-conf
    bounds &lt;- mean(y) + c(-1,1)*sqrt(v)*qt(1-alpha/2,nu)
return(list(bounds=bounds, std.error=sqrt(v)))
}</code></pre>
<pre class="r"><code>by(dat, dat$data, function(data){
  with(data, ranovapred(y, group)$bounds)
  })
## dat$data: dat1
## [1]  1.388652 15.947355
## -------------------------------------------------------- 
## dat$data: dat2
## [1]  7.289183 12.508177</code></pre>
</div>
<div id="bayesian-method-3" class="section level3">
<h3>Bayesian method</h3>
<p>The Bayesian prediction interval is obtained by taking the quantiles of the posterior predictive distribution. One firstly simulates this distribution:</p>
<pre class="r"><code>sims[, ynew:=rnorm(nrow(sims), mu, sqrt(sigma2tot))]</code></pre>
<p>One takes the quantiles:</p>
<pre class="r"><code>sims[, list(lwr=quantile(ynew, 2.5/100), upr=quantile(ynew, 97.5/100)), by=&quot;data&quot;]
##     data        lwr      upr
## 1: data1 -0.2360107 17.55792
## 2: data2  6.0875652 13.72911</code></pre>
<p>For both datasets, the Bayesian prediction interval is larger than the frequentist one.</p>
</div>
</div>
<div id="one-sided-tolerance-interval" class="section level2">
<h2>One-sided tolerance interval</h2>
<p>We provide methods to get lower and upper tolerance limits. Recall this is nothing but a lower/upper confidence bound about a lower/upper quantile, and we will take the lower/upper <span class="math">\(90\%\)</span> quantile as an example. The theoretical values are:</p>
<pre class="r"><code># first dataset
qnorm(c(10,90)/100, 10, sqrt(5))
## [1]  7.134364 12.865636
# second dataset
qnorm(c(10,90)/100, 10, sqrt(2))
## [1]  8.187612 11.812388</code></pre>
<div id="frequentist-method-4" class="section level3">
<h3>Frequentist method</h3>
<p>The <code>ranovatol</code> function provides Krishnamoorthy &amp; Mathew’s tolerance limits given in <a href="/" title="Kalimuthu Krishnamoorthy, Thomas Mathew. *Statistical Tolerance Regions: Theory, Applications, and Computation*. Wiley 2009.">Krishnamoorthy &amp; Mathew</a>’s book.</p>
<pre class="r"><code>ranovatol &lt;- function(y, group, p=0.9, conf=0.95, nsims=50000){
  group &lt;- factor(group)
  I &lt;- length(levels(group))
  if(!all(I*as.numeric(table(group))==length(y))){ stop(&quot;balanced only!&quot;) }
  J &lt;- length(y)/I
  SS &lt;-  SOS(y, group) # sums of squares
  SSb &lt;- SS$SSb; SSw &lt;- SS$SSw
    Z &lt;- rnorm(nsims)
    Ub &lt;- rchisq(nsims, I-1)
    Ue &lt;- rchisq(nsims, I*(J-1)) # ! J*(I-1) in K &amp; M's book is an error
    G &lt;- mean(y)-Z/sqrt(Ub)*sqrt(SSb/I/J)-qnorm(p)/sqrt(J)*sqrt(SSb/Ub+(J-1)*SSw/Ue)
    low &lt;- as.numeric(quantile(G,1-conf)) 
    G &lt;- mean(y) + Z/sqrt(Ub)*sqrt(SSb/I/J) + qnorm(p)/sqrt(J)*sqrt(SSb/Ub+(J-1)*SSw/Ue)
    up &lt;- as.numeric(quantile(G,conf)) 
return(c(lower=low, upper=up))
}</code></pre>
<pre class="r"><code>by(dat, dat$data, function(data){
  with(data, ranovatol(y, group))
  })
## dat$data: dat1
##     lower     upper 
## -2.355055 19.691062 
## -------------------------------------------------------- 
## dat$data: dat2
##     lower     upper 
##  5.870706 13.926654</code></pre>
</div>
<div id="bayesian-method-4" class="section level3">
<h3>Bayesian method</h3>
<p>We proceed as for any parameter of interest. First:</p>
<pre class="r"><code>sims[, c(&quot;tol_lower&quot;,&quot;tol_upper&quot;):=list(qnorm(.1, mu, sqrt(sigma2tot)), qnorm(.9, mu, sqrt(sigma2tot)))]</code></pre>
<p>then:</p>
<pre class="r"><code>sims[, list(lower=quantile(tol_lower, 5/100), upper=quantile(tol_upper, 95/100)), by=&quot;data&quot;]
##     data     lower    upper
## 1: data1 -2.242143 19.58247
## 2: data2  5.534809 14.28729</code></pre>
</div>
</div>
<div id="what-about-the-unbalanced-situation" class="section level1">
<h1>What about the unbalanced situation ?</h1>
<p>I have never tried, but replacing everywhere the sum of squares <span class="math">\(SS_w\)</span> and <span class="math">\(SS_b\)</span> by the <em>unweighted sum of squares</em> should give good results in the unbalanced case. This is known to work well for variance components (see <a href="/" title="R.K. Burdick, C.M. Borror, D.C. Montgomery. *Design and analysis of gauge R&amp;R studies*. ASA-SAM Series on Statistics and Applied Probability 2005.">Burdick &amp; al</a>).</p>
</div>


</div>


              <div id="disqus_thread"></div>
            </li>
          </ol>
          <div class="pagination">
            <ul>
              <li><a href="http://stla.github.com/stlapblog/">&#171; Back Home</a></li>
            </ul>
          </div> 
        </div>
  		</div>
		</div>
  </div>
</body>
  <script src='../libraries/frameworks/purus/js/bootstrap.min.js'></script>
  <script>
      var disqus_developer = 1;
      var disqus_shortname = 'stlapblog'; 
      // required: replace example with your forum shortname
      /* * * DON'T EDIT BELOW THIS LINE * * */
      (function() {
          var dsq = document.createElement('script'); 
          dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || 
           document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <!-- MathJax: Fall back to local if CDN offline but local image fonts are not supported (saves >100MB) -->
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        processEscapes: true
      }
    });
  </script>
  <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/2.0-latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  <!-- <script src="https://c328740.ssl.cf1.rackcdn.com/mathjax/2.0-latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
  </script> -->
  <script>window.MathJax || document.write('<script type="text/x-mathjax-config">MathJax.Hub.Config({"HTML-CSS":{imageFont:null}});<\/script><script src="../libraries/widgets/mathjax/MathJax.js?config=TeX-AMS-MML_HTMLorMML"><\/script>')
</script>
<!-- Google Prettify -->
  <script src="http://cdnjs.cloudflare.com/ajax/libs/prettify/188.0.0/prettify.js"></script>
  <script src='../libraries/highlighters/prettify/js/lang-r.js'></script>
  <script>
    var pres = document.getElementsByTagName("pre");
    for (var i=0; i < pres.length; ++i) {
      pres[i].className = "prettyprint linenums";
    }
    prettyPrint();
  </script>
  <!-- End Google Prettify --> 
  </html>